// includes for Catch2
#include <catch2/catch_test_macros.hpp>
#include <catch2/matchers/catch_matchers_floating_point.hpp>
using Catch::Matchers::WithinRel;

// what we are testing
#include "ENDFtk/gsection/3g.hpp"

// other includes
#include "ENDFtk/tree/Section.hpp"
#include <numeric>

// convenience typedefs
using namespace njoy::ENDFtk;

std::string chunk();
std::string chunkRatios();
std::string chunkClipped();
std::string validSEND();

void verifyChunkRatios(const section::GType< 3 >& );
void verifyChunk(const section::GType< 3 >& );
void verifyChunkClipped(const section::GType< 3 >& );

SCENARIO( "section::GType< 3 >" ) {

  GIVEN( "valid data for a section::GType< 3 > without ratio quantities" ) {

    std::string sectionString = chunk() + validSEND();

    WHEN( "the data is provided explicitly" ) {

      int zaid = 92235;
      double awr = 0.0;
      int mt = 1;
      int nl = 2;
      int nz = 3;
      int lrflag = 0;
      int ngn = 30;
      double temp = 293.6;

      std::vector< unsigned int > groups(30);
      std::iota(groups.begin(), groups.end(), 1);
      std::vector< std::vector< std::vector< double > > > flux = {
        {
            {1.270791e7, 1.149905e6, 1.158584e6, 1.148732e6, 1.155337e6, 1.154847e6, 1.153966e6,
            1.154819e6, 1.153684e6, 1.154784e6, 1.152800e6, 1.156920e6, 1.154341e6, 1.157786e6, 1.156371e6, 5.809202e5,
            7.341455e5, 1.030736e6, 1.175655e6, 5.407961e5, 4.481701e5, 3.429532e5, 2.344895e5, 2.235493e5, 4.396216e4,
            2.311833e4, 1.410474e4, 1.905167e4, 7.393531e4, 3.724272e3},
            {1.197023e7, 1.124479e6, 1.147463e6, 1.143887e6, 1.149144e6, 1.141705e6, 1.144432e6, 1.149445e6, 1.149437e6,
            1.151641e6, 1.150432e6, 1.154913e6, 1.152599e6, 1.156223e6, 1.154994e6, 5.803194e5, 7.334852e5, 1.029938e6,
            1.174846e6, 5.404268e5, 4.478473e5, 3.426903e5, 2.343027e5, 2.233755e5, 4.393264e4, 2.310431e4, 1.409665e4,
            1.904072e4, 7.389235e4, 3.722040e3},
            {2.016090e6, 3.559089e5, 5.945259e5, 8.277563e5, 8.242293e5, 6.987721e5, 7.170965e5, 8.250987e5, 8.671104e5,
            9.151104e5, 9.572601e5, 9.854300e5, 1.002600e6, 1.019964e6, 1.033272e6, 5.264252e5, 6.735186e5, 9.566351e5,
            1.099930e6, 5.062082e5, 4.180345e5, 3.185175e5, 2.171752e5, 2.074169e5, 4.119423e4, 2.179531e4, 1.333844e4,
            1.801546e4, 6.987280e4, 3.513643e3}
        },
        {
            {1.270790e7, 1.149905e6, 1.158584e6, 1.148732e6, 1.155337e6, 1.154847e6,
            1.153966e6, 1.154819e6, 1.153684e6, 1.154784e6, 1.152800e6, 1.156920e6, 1.154341e6, 1.157786e6, 1.156371e6,
            5.809202e5, 7.341455e5, 1.030736e6, 1.175655e6, 5.407961e5, 4.481701e5, 3.429532e5, 2.344895e5, 2.235493e5,
            4.396216e4, 2.311833e4, 1.410474e4, 1.905167e4, 7.393531e4, 3.724272e3},
            {1.128546e7, 1.099624e6, 1.136454e6, 1.139071e6, 1.143039e6, 1.129072e6, 1.135065e6, 1.144111e6, 1.145215e6,
            1.148509e6, 1.148069e6, 1.152910e6, 1.150859e6, 1.154663e6, 1.153620e6, 5.797192e5, 7.328254e5, 1.029141e6,
            1.174038e6, 5.400578e5, 4.475246e5, 3.424276e5, 2.341160e5, 2.232019e5, 4.390314e4, 2.309029e4, 1.408855e4,
            1.902977e4, 7.384941e4, 3.719810e3},
            {3.552522e5, 1.113871e5, 3.080750e5, 6.075435e5, 6.180888e5, 4.707030e5, 4.826207e5,
            6.107359e5, 6.661531e5, 7.306688e5, 7.958322e5, 8.391668e5, 8.706505e5, 8.985596e5, 9.232978e5, 4.770473e5,
            6.179062e5, 8.878708e5, 1.029084e6, 4.738327e5, 3.899259e5, 2.958232e5, 2.011394e5, 1.924498e5, 3.860075e4,
            2.054803e4, 1.261378e4, 1.703561e4, 6.603351e4, 3.314928e3}
        }
      };

      std::vector< std::vector< std::vector< double > > > sigma = {
        {
            {6.266544e2, 2.261991e2, 9.695867e1, 4.242725e1, 5.437948e1, 1.185407e2, 8.411095e1,
            4.690043e1, 3.702289e1, 2.730364e1, 2.058304e1, 1.737549e1, 1.511328e1, 1.351391e1, 1.191600e1, 1.035308e1,
            9.002912, 7.747087, 6.884748, 6.832784, 7.209057, 7.671847, 7.972503, 7.778415, 6.719709,
            6.070456, 5.745072, 5.751786, 5.814161, 5.994611},
            {6.162562e2, 2.261133e2, 9.691458e1, 4.235340e1, 5.388817e1, 1.151101e2, 8.330874e1, 4.675655e1, 3.694638e1,
            2.728690e1, 2.058112e1, 1.737619e1, 1.511373e1, 1.351390e1, 1.191598e1, 1.035307e1, 9.002896, 7.747076,
            6.884747, 6.832784, 7.209055, 7.671845, 7.972503, 7.778410, 6.719703, 6.070453, 5.745068,
            5.751786, 5.814160, 5.994612},
            {5.303243e2, 2.230897e2, 9.487519e1, 3.877662e1, 4.017175e1, 6.526800e1, 6.092206e1,
            3.996131e1, 3.304928e1, 2.619063e1, 2.042701e1, 1.740253e1, 1.513475e1, 1.351245e1, 1.191350e1, 1.035190e1,
            9.001521, 7.745969, 6.884560, 6.832738, 7.208877, 7.671702, 7.972488, 7.777768, 6.719217, 6.070241,
            5.745052, 5.751784, 5.814157, 5.994582}
        },
        {
            {6.266548e2, 2.261991e2, 9.695867e1, 4.242725e1, 5.437948e1, 1.185407e2, 8.411095e1, 4.690043e1, 3.702289e1,
            2.730364e1, 2.058304e1, 1.737549e1, 1.511328e1, 1.351391e1, 1.191600e1, 1.035308e1, 9.002912, 7.747087,
            6.884748, 6.832784, 7.209057, 7.671847, 7.972503, 7.778415, 6.719709, 6.070456, 5.745072,
            5.751786, 5.814161, 5.994611},
            {6.067706e2, 2.260272e2, 9.687056e1, 4.228004e1, 5.341036e1, 1.118811e2, 8.252645e1, 4.661387e1, 3.687041e1,
            2.727020e1, 2.057925e1, 1.737692e1, 1.511419e1, 1.351388e1, 1.191594e1, 1.035305e1, 9.002881, 7.747061,
            6.884743, 6.832783, 7.209054, 7.671843, 7.972504, 7.778402, 6.719698, 6.070451, 5.745070,
            5.751787, 5.814161, 5.994612},
            {4.675096e2, 2.195244e2, 9.298089e1, 3.624642e1, 3.335129e1, 4.845287e1, 4.858386e1, 3.509910e1, 3.016684e1,
            2.524285e1, 2.028417e1, 1.742958e1, 1.515522e1, 1.351098e1, 1.191100e1, 1.035072e1, 9.000132, 7.744850,
            6.884374, 6.832691, 7.208697, 7.671560, 7.972473, 7.777122, 6.718726, 6.070030, 5.745030,
            5.751781, 5.814154, 5.994551}
        }
      };

      section::GType< 3 > chunk( mt, zaid, awr, nl, nz, lrflag, ngn, temp, groups, flux, sigma );

      THEN( "a section GType< 3 > can be constructed and members can be tested" ) {

        verifyChunk(chunk);
      } // THEN

      THEN( "it can be printed" ) {

        std::string buffer;
        auto output = std::back_inserter(buffer);
        chunk.print(output, 9228, 3);

        CHECK(buffer == sectionString);
      } // THEN
    } // WHEN

    WHEN( "the data is given as a string" ) {

      std::string line = chunk() + validSEND();
      auto begin = line.begin();
      auto end = line.end();
      long lineNumber = 0;
      auto head = HeadRecord(begin, end, lineNumber);

      section::GType< 3 > chunk(head, begin, end, lineNumber, 9228);

      THEN( "a section GType<3> can be constructed and members can be tested" ) {

        verifyChunk(chunk);
      } // THEN

      THEN( "it can be printed" ) {

        std::string buffer;
        auto output = std::back_inserter(buffer);
        chunk.print(output, 9228, 3);

        CHECK(buffer == sectionString);
      } // THEN

      THEN( "ratios are requested, it will error out" ) {

        CHECK_THROWS( chunk.ratio(0,0) );
      } // THEN
    } // WHEN
  } // GIVEN

  GIVEN( "valid data for a section::GType< 3 > with ratios" ) {

    std::string sectionString = chunkRatios() + validSEND();

    WHEN( "the correct parameters to construct a section::GType< 3 >" ) {

      int zaid = 92235;
      double awr = 0.0;
      int mt = 452;
      int nl = 1;
      int nz = 1;
      int lrflag = 0;
      int ngn = 30;
      double temp = 293.6;

      std::vector< unsigned int > groups(30);
      std::iota(groups.begin(), groups.end(), 1);

      std::vector < std::vector< std::vector< double > > > flux =
      {{{1.270791e7, 1.149905e6, 1.158584e6, 1.148732e6, 1.155337e6, 1.154847e6, 1.153966e6,
          1.154819e6, 1.153684e6, 1.154784e6, 1.152800e6, 1.156920e6, 1.154341e6, 1.157786e6, 1.156371e6, 5.809202e5,
          7.341455e5, 1.030736e6, 1.175655e6, 5.407961e5, 4.481701e5, 3.429532e5, 2.344895e5, 2.235493e5, 4.396216e4,
          2.311833e4, 1.410474e4, 1.905167e4, 7.393531e4, 3.724272e3}}};

      std::vector < std::vector< std::vector< double > > > ratio =
      {{{2.429850, 2.431545, 2.433314, 2.402490, 2.402713, 2.397356, 2.426825,
          2.436916, 2.442703, 2.430792, 2.434855, 2.419640, 2.426568, 2.417260, 2.439160, 2.467889,
          2.479153, 2.496982, 2.528400, 2.586487, 2.642705, 2.716914, 2.800571, 2.988991, 3.409679,
          3.663458, 3.968481, 4.260765, 4.415797, 4.651492}}};

      std::vector < std::vector< std::vector< double > > > sigma =
      {{{5.232180e2, 1.754828e2, 7.256555e1, 2.118119e1, 2.022788e1, 6.453574e1, 4.674539e1,
          2.265849e1, 1.763465e1, 1.090636e1, 5.999898, 3.849512, 2.560637, 1.929781, 1.536979, 1.298960,
          1.193878, 1.123199, 1.185698, 1.244700, 1.280184, 1.259628, 1.197753, 1.108814, 1.438964,
          1.778379, 1.730948, 1.873645, 2.067954, 2.135172}}};

      section::GType<3> chunkRatios(mt, zaid, awr, nl, nz, lrflag, ngn, temp, groups, flux, sigma, ratio );

      THEN( "a section::GType<3> can be constructed and "
            "members can be tested.") {

        verifyChunkRatios(chunkRatios);
      } // THEN

      THEN( "it can be printed" ) {

        std::string buffer;
        auto output = std::back_inserter(buffer);
        chunkRatios.print( output, 9228, 3 );

        CHECK(buffer == sectionString);
      } // THEN
    } // WHEN

    WHEN( "the data is read from a string with a valid SEND" ) {

      auto begin = sectionString.begin();
      auto end = sectionString.end();
      long lineNumber = 0;
      HeadRecord head( begin, end, lineNumber );

      section::GType< 3 > chunkRatios( head, begin, end, lineNumber, 9228 );

      THEN( "a gsection::GType<3> can be constructed and"
            "members can be tested." ) {

        verifyChunkRatios(chunkRatios);
      } // THEN

      THEN( "it can be printed" ) {

        std::string buffer;
        auto output = std::back_inserter(buffer);
        chunkRatios.print( output, 9228, 3);

        CHECK(buffer == sectionString);
      } // THEN
    } // WHEN
  } // GIVEN

  GIVEN( "valid data for a GType< 3 > section that's been clipped" ) {

    std::string sectionString = chunkClipped() + validSEND();

    WHEN( "when the data is given explicitly" ) {

      int zaid = 92235;
      double awr = 0.0;
      int mt = 16;
      int nl = 1;
      int nz = 1;
      int lrflag = 0;
      int ngn = 30;
      double temp = 293.6;

      std::vector< unsigned int > groups(30);
      std::iota(groups.begin(), groups.end(), 1);

      std::vector < std::vector< std::vector< double> > > flux = {{{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 2.235493e5, 4.396216e4, 2.311833e4, 1.410474e4, 1.905167e4,
      7.393531e4, 3.724272e3
      }}};
      std::vector < std::vector< std::vector< double> > > sigma = {{{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 1.047471e-2, 3.690336e-1, 6.475546e-1, 8.511604e-1, 7.647669e-1,
      5.483544e-1, 3.717841e-1
      }}};

      section::GType< 3 > chunkClipped(mt, zaid, awr, nl, nz, lrflag, ngn, temp, groups, flux, sigma );

      THEN( "a section GType<3> can be constructed and members can be tested" ) {

        verifyChunkClipped(chunkClipped);
      } // THEN

      THEN( "it can be printed" ) {

        std::string buffer;
        auto output = std::back_inserter(buffer);
        chunkClipped.print(output, 9228, 3);

        CHECK(buffer == sectionString);
      } // THEN
    } // WHEN

    WHEN("when the data is given as a string") {

      std::string line = chunkClipped() + validSEND();
      auto begin = line.begin();
      auto end = line.end();
      long lineNumber = 0;
      auto head = HeadRecord(begin, end, lineNumber);

      section::GType< 3 > chunkClipped(head, begin, end, lineNumber, 9228);

      THEN( "a section::GType<3> can be constructed and its "
           "members can be constructed and tested" ) {

        verifyChunkClipped(chunkClipped);
      } // THEN

      THEN("it can be printed") {

        std::string buffer;
        auto output = std::back_inserter(buffer);
        chunkClipped.print(output, 9228, 3);

        CHECK(buffer == sectionString);
      } // THEN
    } // WHEN
  } // GIVEN
} // SCENARIO

std::string chunk() {

  return
    " 9.223500+4 0.000000+0          2          3          0         309228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          19228 3  1     \n"
    " 1.270791+7 1.270790+7 1.197023+7 1.128546+7 2.016090+6 3.552522+59228 3  1     \n"
    " 6.266544+2 6.266548+2 6.162562+2 6.067706+2 5.303243+2 4.675096+29228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          29228 3  1     \n"
    " 1.149905+6 1.149905+6 1.124479+6 1.099624+6 3.559089+5 1.113871+59228 3  1     \n"
    " 2.261991+2 2.261991+2 2.261133+2 2.260272+2 2.230897+2 2.195244+29228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          39228 3  1     \n"
    " 1.158584+6 1.158584+6 1.147463+6 1.136454+6 5.945259+5 3.080750+59228 3  1     \n"
    " 9.695867+1 9.695867+1 9.691458+1 9.687056+1 9.487519+1 9.298089+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          49228 3  1     \n"
    " 1.148732+6 1.148732+6 1.143887+6 1.139071+6 8.277563+5 6.075435+59228 3  1     \n"
    " 4.242725+1 4.242725+1 4.235340+1 4.228004+1 3.877662+1 3.624642+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          59228 3  1     \n"
    " 1.155337+6 1.155337+6 1.149144+6 1.143039+6 8.242293+5 6.180888+59228 3  1     \n"
    " 5.437948+1 5.437948+1 5.388817+1 5.341036+1 4.017175+1 3.335129+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          69228 3  1     \n"
    " 1.154847+6 1.154847+6 1.141705+6 1.129072+6 6.987721+5 4.707030+59228 3  1     \n"
    " 1.185407+2 1.185407+2 1.151101+2 1.118811+2 6.526800+1 4.845287+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          79228 3  1     \n"
    " 1.153966+6 1.153966+6 1.144432+6 1.135065+6 7.170965+5 4.826207+59228 3  1     \n"
    " 8.411095+1 8.411095+1 8.330874+1 8.252645+1 6.092206+1 4.858386+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          89228 3  1     \n"
    " 1.154819+6 1.154819+6 1.149445+6 1.144111+6 8.250987+5 6.107359+59228 3  1     \n"
    " 4.690043+1 4.690043+1 4.675655+1 4.661387+1 3.996131+1 3.509910+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          99228 3  1     \n"
    " 1.153684+6 1.153684+6 1.149437+6 1.145215+6 8.671104+5 6.661531+59228 3  1     \n"
    " 3.702289+1 3.702289+1 3.694638+1 3.687041+1 3.304928+1 3.016684+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         109228 3  1     \n"
    " 1.154784+6 1.154784+6 1.151641+6 1.148509+6 9.151104+5 7.306688+59228 3  1     \n"
    " 2.730364+1 2.730364+1 2.728690+1 2.727020+1 2.619063+1 2.524285+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         119228 3  1     \n"
    " 1.152800+6 1.152800+6 1.150432+6 1.148069+6 9.572601+5 7.958322+59228 3  1     \n"
    " 2.058304+1 2.058304+1 2.058112+1 2.057925+1 2.042701+1 2.028417+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         129228 3  1     \n"
    " 1.156920+6 1.156920+6 1.154913+6 1.152910+6 9.854300+5 8.391668+59228 3  1     \n"
    " 1.737549+1 1.737549+1 1.737619+1 1.737692+1 1.740253+1 1.742958+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         139228 3  1     \n"
    " 1.154341+6 1.154341+6 1.152599+6 1.150859+6 1.002600+6 8.706505+59228 3  1     \n"
    " 1.511328+1 1.511328+1 1.511373+1 1.511419+1 1.513475+1 1.515522+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         149228 3  1     \n"
    " 1.157786+6 1.157786+6 1.156223+6 1.154663+6 1.019964+6 8.985596+59228 3  1     \n"
    " 1.351391+1 1.351391+1 1.351390+1 1.351388+1 1.351245+1 1.351098+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         159228 3  1     \n"
    " 1.156371+6 1.156371+6 1.154994+6 1.153620+6 1.033272+6 9.232978+59228 3  1     \n"
    " 1.191600+1 1.191600+1 1.191598+1 1.191594+1 1.191350+1 1.191100+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         169228 3  1     \n"
    " 5.809202+5 5.809202+5 5.803194+5 5.797192+5 5.264252+5 4.770473+59228 3  1     \n"
    " 1.035308+1 1.035308+1 1.035307+1 1.035305+1 1.035190+1 1.035072+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         179228 3  1     \n"
    " 7.341455+5 7.341455+5 7.334852+5 7.328254+5 6.735186+5 6.179062+59228 3  1     \n"
    " 9.002912+0 9.002912+0 9.002896+0 9.002881+0 9.001521+0 9.000132+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         189228 3  1     \n"
    " 1.030736+6 1.030736+6 1.029938+6 1.029141+6 9.566351+5 8.878708+59228 3  1     \n"
    " 7.747087+0 7.747087+0 7.747076+0 7.747061+0 7.745969+0 7.744850+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         199228 3  1     \n"
    " 1.175655+6 1.175655+6 1.174846+6 1.174038+6 1.099930+6 1.029084+69228 3  1     \n"
    " 6.884748+0 6.884748+0 6.884747+0 6.884743+0 6.884560+0 6.884374+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         209228 3  1     \n"
    " 5.407961+5 5.407961+5 5.404268+5 5.400578+5 5.062082+5 4.738327+59228 3  1     \n"
    " 6.832784+0 6.832784+0 6.832784+0 6.832783+0 6.832738+0 6.832691+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         219228 3  1     \n"
    " 4.481701+5 4.481701+5 4.478473+5 4.475246+5 4.180345+5 3.899259+59228 3  1     \n"
    " 7.209057+0 7.209057+0 7.209055+0 7.209054+0 7.208877+0 7.208697+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         229228 3  1     \n"
    " 3.429532+5 3.429532+5 3.426903+5 3.424276+5 3.185175+5 2.958232+59228 3  1     \n"
    " 7.671847+0 7.671847+0 7.671845+0 7.671843+0 7.671702+0 7.671560+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         239228 3  1     \n"
    " 2.344895+5 2.344895+5 2.343027+5 2.341160+5 2.171752+5 2.011394+59228 3  1     \n"
    " 7.972503+0 7.972503+0 7.972503+0 7.972504+0 7.972488+0 7.972473+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         249228 3  1     \n"
    " 2.235493+5 2.235493+5 2.233755+5 2.232019+5 2.074169+5 1.924498+59228 3  1     \n"
    " 7.778415+0 7.778415+0 7.778410+0 7.778402+0 7.777768+0 7.777122+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         259228 3  1     \n"
    " 4.396216+4 4.396216+4 4.393264+4 4.390314+4 4.119423+4 3.860075+49228 3  1     \n"
    " 6.719709+0 6.719709+0 6.719703+0 6.719698+0 6.719217+0 6.718726+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         269228 3  1     \n"
    " 2.311833+4 2.311833+4 2.310431+4 2.309029+4 2.179531+4 2.054803+49228 3  1     \n"
    " 6.070456+0 6.070456+0 6.070453+0 6.070451+0 6.070241+0 6.070030+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         279228 3  1     \n"
    " 1.410474+4 1.410474+4 1.409665+4 1.408855+4 1.333844+4 1.261378+49228 3  1     \n"
    " 5.745072+0 5.745072+0 5.745068+0 5.745070+0 5.745052+0 5.745030+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         289228 3  1     \n"
    " 1.905167+4 1.905167+4 1.904072+4 1.902977+4 1.801546+4 1.703561+49228 3  1     \n"
    " 5.751786+0 5.751786+0 5.751786+0 5.751787+0 5.751784+0 5.751781+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         299228 3  1     \n"
    " 7.393531+4 7.393531+4 7.389235+4 7.384941+4 6.987280+4 6.603351+49228 3  1     \n"
    " 5.814161+0 5.814161+0 5.814160+0 5.814161+0 5.814157+0 5.814154+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         309228 3  1     \n"
    " 3.724272+3 3.724272+3 3.722040+3 3.719810+3 3.513643+3 3.314928+39228 3  1     \n"
    " 5.994611+0 5.994611+0 5.994612+0 5.994612+0 5.994582+0 5.994551+09228 3  1     \n";
}

std::string validSEND() {

  return
    "                                                                  9228 3  0     \n";
}

void verifyChunk( const section::GType< 3 >& chunk ) {

  CHECK(92235 == chunk.ZA());
  CHECK(92235 == chunk.targetIdentifier());
  CHECK(1 == chunk.MT());
  CHECK(1 == chunk.sectionNumber());
  CHECK(2 == chunk.NL());
  CHECK(2 == chunk.numberMoments());
  CHECK(30 == chunk.NGN());
  CHECK(30 == chunk.numberNeutronGroups());
  CHECK(3 == chunk.NZ());
  CHECK(3 == chunk.numberDilutions());
  CHECK(0 == chunk.LRFLAG());
  CHECK(0 == chunk.breakUpID());
  CHECK_THAT( 293.6, WithinRel( chunk.temperature() ) );
  std::vector<unsigned int> expected_groups(30);
  std::iota(expected_groups.begin(), expected_groups.end(), 1);
  for (size_t i = 0; i < chunk.NGN(); ++i) {
      CHECK(expected_groups[i] == chunk.groups()[i]);
  }
  // flux_nl_nz
  std::vector<double> flux_0_0 = {1.270791e7, 1.149905e6, 1.158584e6, 1.148732e6, 1.155337e6, 1.154847e6, 1.153966e6,
     1.154819e6, 1.153684e6, 1.154784e6, 1.152800e6, 1.156920e6, 1.154341e6, 1.157786e6, 1.156371e6, 5.809202e5,
     7.341455e5, 1.030736e6, 1.175655e6, 5.407961e5, 4.481701e5, 3.429532e5, 2.344895e5, 2.235493e5, 4.396216e4,
     2.311833e4, 1.410474e4, 1.905167e4, 7.393531e4, 3.724272e3};
  for (size_t i = 0; i < chunk.NGN(); ++i) {
      CHECK_THAT(flux_0_0[i], WithinRel(chunk.flux(0, 0)[i]));
  }
  std::vector<double> flux_0_1 = {1.197023e7, 1.124479e6, 1.147463e6, 1.143887e6, 1.149144e6, 1.141705e6, 1.144432e6, 1.149445e6, 1.149437e6,
                  1.151641e6, 1.150432e6, 1.154913e6, 1.152599e6, 1.156223e6, 1.154994e6, 5.803194e5, 7.334852e5, 1.029938e6,
                  1.174846e6, 5.404268e5, 4.478473e5, 3.426903e5, 2.343027e5, 2.233755e5, 4.393264e4, 2.310431e4, 1.409665e4,
                  1.904072e4, 7.389235e4, 3.722040e3};
  for (size_t i = 0; i< chunk.NGN(); ++i) {
      CHECK_THAT(flux_0_1[i], WithinRel(chunk.flux(0, 1)[i]));
  }
  std::vector< double > flux_0_2 = {2.016090e6, 3.559089e5, 5.945259e5, 8.277563e5, 8.242293e5, 6.987721e5, 7.170965e5, 8.250987e5, 8.671104e5,
                  9.151104e5, 9.572601e5, 9.854300e5, 1.002600e6, 1.019964e6, 1.033272e6, 5.264252e5, 6.735186e5, 9.566351e5,
                  1.099930e6, 5.062082e5, 4.180345e5, 3.185175e5, 2.171752e5, 2.074169e5, 4.119423e4, 2.179531e4, 1.333844e4,
                  1.801546e4, 6.987280e4, 3.513643e3};
  for (size_t i = 0; i < chunk.NGN(); ++i) {
      CHECK_THAT(flux_0_2[i], WithinRel(chunk.flux(0, 2)[i]));
  }
  std::vector< double > flux_1_0 = {1.270790e7, 1.149905e6, 1.158584e6, 1.148732e6, 1.155337e6, 1.154847e6,
      1.153966e6, 1.154819e6, 1.153684e6, 1.154784e6, 1.152800e6, 1.156920e6, 1.154341e6, 1.157786e6, 1.156371e6,
      5.809202e5, 7.341455e5, 1.030736e6, 1.175655e6, 5.407961e5, 4.481701e5, 3.429532e5, 2.344895e5, 2.235493e5,
      4.396216e4, 2.311833e4, 1.410474e4, 1.905167e4, 7.393531e4, 3.724272e3};
  for (size_t i = 0; i < chunk.NGN(); ++i) {
      CHECK_THAT(flux_1_0[i], WithinRel(chunk.flux(1,0)[i]));
  }
  std::vector< double > flux_1_1 = {1.128546e7, 1.099624e6, 1.136454e6, 1.139071e6, 1.143039e6, 1.129072e6, 1.135065e6, 1.144111e6, 1.145215e6,
                  1.148509e6, 1.148069e6, 1.152910e6, 1.150859e6, 1.154663e6, 1.153620e6, 5.797192e5, 7.328254e5, 1.029141e6,
                  1.174038e6, 5.400578e5, 4.475246e5, 3.424276e5, 2.341160e5, 2.232019e5, 4.390314e4, 2.309029e4, 1.408855e4,
                  1.902977e4, 7.384941e4, 3.719810e3};
  for (size_t i = 0; i< chunk.NGN(); ++i) {
      CHECK_THAT(flux_1_1[i], WithinRel(chunk.flux(1, 1)[i]));
  }
  std::vector< double > flux_1_2 = {3.552522e5, 1.113871e5, 3.080750e5, 6.075435e5, 6.180888e5, 4.707030e5, 4.826207e5,
      6.107359e5, 6.661531e5, 7.306688e5, 7.958322e5, 8.391668e5, 8.706505e5, 8.985596e5, 9.232978e5, 4.770473e5,
      6.179062e5, 8.878708e5, 1.029084e6, 4.738327e5, 3.899259e5, 2.958232e5, 2.011394e5, 1.924498e5, 3.860075e4,
      2.054803e4, 1.261378e4, 1.703561e4, 6.603351e4, 3.314928e3};
  for (size_t i = 0; i< chunk.NGN(); ++i) {
      CHECK_THAT(flux_1_2[i], WithinRel(chunk.flux(1, 2)[i]));
  }
  std::vector< double > sigma_0_0 = {6.266544e2, 2.261991e2, 9.695867e1, 4.242725e1, 5.437948e1, 1.185407e2, 8.411095e1,
      4.690043e1, 3.702289e1, 2.730364e1, 2.058304e1, 1.737549e1, 1.511328e1, 1.351391e1, 1.191600e1, 1.035308e1,
      9.002912, 7.747087, 6.884748, 6.832784, 7.209057, 7.671847, 7.972503, 7.778415, 6.719709,
      6.070456, 5.745072, 5.751786, 5.814161, 5.994611};
  for (size_t i = 0; i < chunk.NGN(); ++i) {
      CHECK_THAT(sigma_0_0[i], WithinRel(chunk.crossSection(0,0)[i]));
  }
  std::vector< double > sigma_0_1 = {6.162562e2, 2.261133e2, 9.691458e1, 4.235340e1, 5.388817e1, 1.151101e2, 8.330874e1, 4.675655e1, 3.694638e1,
  2.728690e1, 2.058112e1, 1.737619e1, 1.511373e1, 1.351390e1, 1.191598e1, 1.035307e1, 9.002896, 7.747076,
  6.884747, 6.832784, 7.209055, 7.671845, 7.972503, 7.778410, 6.719703, 6.070453, 5.745068,
  5.751786, 5.814160, 5.994612};
  for (size_t i = 0; i < chunk.NGN(); ++i) {
      CHECK_THAT(sigma_0_1[i], WithinRel(chunk.crossSection(0,1)[i]));
  }
  std::vector< double > sigma_0_2 = {5.303243e2, 2.230897e2, 9.487519e1, 3.877662e1, 4.017175e1, 6.526800e1, 6.092206e1,
  3.996131e1, 3.304928e1, 2.619063e1, 2.042701e1, 1.740253e1, 1.513475e1, 1.351245e1, 1.191350e1, 1.035190e1,
  9.001521, 7.745969, 6.884560, 6.832738, 7.208877, 7.671702, 7.972488, 7.777768, 6.719217, 6.070241,
  5.745052, 5.751784, 5.814157, 5.994582};
  for (size_t i = 0; i < chunk.NGN(); ++i) {
      CHECK_THAT(sigma_0_2[i], WithinRel(chunk.crossSection(0,2)[i]));
  }
  std::vector< double > sigma_1_0 = {6.266548e2, 2.261991e2, 9.695867e1, 4.242725e1, 5.437948e1, 1.185407e2, 8.411095e1, 4.690043e1, 3.702289e1,
  2.730364e1, 2.058304e1, 1.737549e1, 1.511328e1, 1.351391e1, 1.191600e1, 1.035308e1, 9.002912, 7.747087,
  6.884748, 6.832784, 7.209057, 7.671847, 7.972503, 7.778415, 6.719709, 6.070456, 5.745072,
  5.751786, 5.814161, 5.994611};
  for (size_t i = 0; i < chunk.NGN(); ++i) {
      CHECK_THAT(sigma_1_0[i], WithinRel(chunk.crossSection(1,0)[i]));
  }
  std::vector< double > sigma_1_1 = {6.067706e2, 2.260272e2, 9.687056e1, 4.228004e1, 5.341036e1, 1.118811e2, 8.252645e1, 4.661387e1, 3.687041e1,
  2.727020e1, 2.057925e1, 1.737692e1, 1.511419e1, 1.351388e1, 1.191594e1, 1.035305e1, 9.002881, 7.747061,
  6.884743, 6.832783, 7.209054, 7.671843, 7.972504, 7.778402, 6.719698, 6.070451, 5.745070,
  5.751787, 5.814161, 5.994612};
  for (size_t i = 0; i < chunk.NGN(); ++i) {
      CHECK_THAT(sigma_1_1[i], WithinRel(chunk.crossSection(1,1)[i]));
  }
  std::vector< double > sigma_1_2 = {4.675096e2, 2.195244e2, 9.298089e1, 3.624642e1, 3.335129e1, 4.845287e1, 4.858386e1, 3.509910e1, 3.016684e1,
  2.524285e1, 2.028417e1, 1.742958e1, 1.515522e1, 1.351098e1, 1.191100e1, 1.035072e1, 9.000132, 7.744850,
  6.884374, 6.832691, 7.208697, 7.671560, 7.972473, 7.777122, 6.718726, 6.070030, 5.745030,
  5.751781, 5.814154, 5.994551};
  for (size_t i = 0; i < chunk.NGN(); ++i) {
      CHECK_THAT(sigma_1_2[i], WithinRel(chunk.crossSection(1,2)[i]));
  }
}

std::string chunkRatios() {

  return
    " 9.223500+4 0.000000+0          1          1          0         309228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3          19228 3452     \n"
    " 1.270791+7 2.429850+0 5.232180+2                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3          29228 3452     \n"
    " 1.149905+6 2.431545+0 1.754828+2                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3          39228 3452     \n"
    " 1.158584+6 2.433314+0 7.256555+1                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3          49228 3452     \n"
    " 1.148732+6 2.402490+0 2.118119+1                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3          59228 3452     \n"
    " 1.155337+6 2.402713+0 2.022788+1                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3          69228 3452     \n"
    " 1.154847+6 2.397356+0 6.453574+1                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3          79228 3452     \n"
    " 1.153966+6 2.426825+0 4.674539+1                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3          89228 3452     \n"
    " 1.154819+6 2.436916+0 2.265849+1                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3          99228 3452     \n"
    " 1.153684+6 2.442703+0 1.763465+1                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         109228 3452     \n"
    " 1.154784+6 2.430792+0 1.090636+1                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         119228 3452     \n"
    " 1.152800+6 2.434855+0 5.999898+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         129228 3452     \n"
    " 1.156920+6 2.419640+0 3.849512+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         139228 3452     \n"
    " 1.154341+6 2.426568+0 2.560637+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         149228 3452     \n"
    " 1.157786+6 2.417260+0 1.929781+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         159228 3452     \n"
    " 1.156371+6 2.439160+0 1.536979+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         169228 3452     \n"
    " 5.809202+5 2.467889+0 1.298960+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         179228 3452     \n"
    " 7.341455+5 2.479153+0 1.193878+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         189228 3452     \n"
    " 1.030736+6 2.496982+0 1.123199+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         199228 3452     \n"
    " 1.175655+6 2.528400+0 1.185698+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         209228 3452     \n"
    " 5.407961+5 2.586487+0 1.244700+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         219228 3452     \n"
    " 4.481701+5 2.642705+0 1.280184+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         229228 3452     \n"
    " 3.429532+5 2.716914+0 1.259628+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         239228 3452     \n"
    " 2.344895+5 2.800571+0 1.197753+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         249228 3452     \n"
    " 2.235493+5 2.988991+0 1.108814+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         259228 3452     \n"
    " 4.396216+4 3.409679+0 1.438964+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         269228 3452     \n"
    " 2.311833+4 3.663458+0 1.778379+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         279228 3452     \n"
    " 1.410474+4 3.968481+0 1.730948+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         289228 3452     \n"
    " 1.905167+4 4.260765+0 1.873645+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         299228 3452     \n"
    " 7.393531+4 4.415797+0 2.067954+0                                 9228 3452     \n"
    " 2.936000+2 0.000000+0          3          1          3         309228 3452     \n"
    " 3.724272+3 4.651492+0 2.135172+0                                 9228 3452     \n";
}

void verifyChunkRatios( const section::GType< 3 >& chunkRatios ) {

  CHECK(92235 == chunkRatios.ZA());
  CHECK(92235 == chunkRatios.targetIdentifier());
  CHECK(452 == chunkRatios.MT());
  CHECK(452 == chunkRatios.sectionNumber());
  CHECK(1 == chunkRatios.NL());
  CHECK(1 == chunkRatios.numberMoments());
  CHECK(1 == chunkRatios.NZ());
  CHECK(1 == chunkRatios.numberDilutions());
  CHECK(30 == chunkRatios.NGN());
  CHECK(30 == chunkRatios.numberNeutronGroups());
  CHECK(1 == chunkRatios.NZ());
  CHECK(1 == chunkRatios.numberDilutions());
  CHECK(0 == chunkRatios.LRFLAG());
  CHECK(0 == chunkRatios.breakUpID());
  CHECK_THAT( 293.6, WithinRel( chunkRatios.temperature() ) );
  std::vector<unsigned int> expected_groups(30);
  std::iota(expected_groups.begin(), expected_groups.end(), 1);
  for (size_t i = 0; i < chunkRatios.NGN(); ++i) {
      CHECK(expected_groups[i] == chunkRatios.groups()[i]);
  }
  std::vector < std::vector< std::vector< double> > > flux =
      {{{1.270791e7, 1.149905e6, 1.158584e6, 1.148732e6, 1.155337e6, 1.154847e6, 1.153966e6,
          1.154819e6, 1.153684e6, 1.154784e6, 1.152800e6, 1.156920e6, 1.154341e6, 1.157786e6, 1.156371e6, 5.809202e5,
          7.341455e5, 1.030736e6, 1.175655e6, 5.407961e5, 4.481701e5, 3.429532e5, 2.344895e5, 2.235493e5, 4.396216e4,
          2.311833e4, 1.410474e4, 1.905167e4, 7.393531e4, 3.724272e3}}};
  for (size_t i = 0; i < chunkRatios.NGN(); ++i) {
      CHECK_THAT(flux[0][0][i], WithinRel(chunkRatios.flux(0, 0)[i]));
  }

  std::vector < std::vector< std::vector< double> > > ratio =
      {{{2.429850, 2.431545, 2.433314, 2.402490, 2.402713, 2.397356, 2.426825,
          2.436916, 2.442703, 2.430792, 2.434855, 2.419640, 2.426568, 2.417260, 2.439160, 2.467889,
          2.479153, 2.496982, 2.528400, 2.586487, 2.642705, 2.716914, 2.800571, 2.988991, 3.409679,
          3.663458, 3.968481, 4.260765, 4.415797, 4.651492}}};
  for (size_t i = 0; i < chunkRatios.NGN(); ++i) {
      CHECK_THAT(ratio[0][0][i], WithinRel(chunkRatios.ratio(0, 0)[i]));
  }

  std::vector < std::vector< std::vector< double> > > sigma =
      {{{5.232180e2, 1.754828e2, 7.256555e1, 2.118119e1, 2.022788e1, 6.453574e1, 4.674539e1,
          2.265849e1, 1.763465e1, 1.090636e1, 5.999898, 3.849512, 2.560637, 1.929781, 1.536979, 1.298960,
          1.193878, 1.123199, 1.185698, 1.244700, 1.280184, 1.259628, 1.197753, 1.108814, 1.438964,
          1.778379, 1.730948, 1.873645, 2.067954, 2.135172}}};
  for (size_t i = 0; i < chunkRatios.NGN(); ++i) {
      CHECK_THAT(sigma[0][0][i], WithinRel(chunkRatios.crossSection(0, 0)[i]));
  }
}

std::string chunkClipped() {

  return
    " 9.223500+4 0.000000+0          1          1          0         309228 3 16     \n"
    " 2.936000+2 0.000000+0          2          1          2         249228 3 16     \n"
    " 2.235493+5 1.047471-2                                            9228 3 16     \n"
    " 2.936000+2 0.000000+0          2          1          2         259228 3 16     \n"
    " 4.396216+4 3.690336-1                                            9228 3 16     \n"
    " 2.936000+2 0.000000+0          2          1          2         269228 3 16     \n"
    " 2.311833+4 6.475546-1                                            9228 3 16     \n"
    " 2.936000+2 0.000000+0          2          1          2         279228 3 16     \n"
    " 1.410474+4 8.511604-1                                            9228 3 16     \n"
    " 2.936000+2 0.000000+0          2          1          2         289228 3 16     \n"
    " 1.905167+4 7.647669-1                                            9228 3 16     \n"
    " 2.936000+2 0.000000+0          2          1          2         299228 3 16     \n"
    " 7.393531+4 5.483544-1                                            9228 3 16     \n"
    " 2.936000+2 0.000000+0          2          1          2         309228 3 16     \n"
    " 3.724272+3 3.717841-1                                            9228 3 16     \n";
}

void verifyChunkClipped( const section::GType<3>& chunkClipped ) {

    CHECK(92235 == chunkClipped.ZA());
    CHECK(92235 == chunkClipped.targetIdentifier());
    CHECK(16 == chunkClipped.MT());
    CHECK(16 == chunkClipped.sectionNumber());
    CHECK(1 == chunkClipped.NL());
    CHECK(1 == chunkClipped.numberMoments());
    CHECK(1 == chunkClipped.NZ());
    CHECK(1 == chunkClipped.numberDilutions());
    CHECK(30 == chunkClipped.NGN());
    CHECK(30 == chunkClipped.numberNeutronGroups());
    CHECK(1 == chunkClipped.NZ());
    CHECK(1 == chunkClipped.numberDilutions());
    CHECK(0 == chunkClipped.LRFLAG());
    CHECK(0 == chunkClipped.breakUpID());
    CHECK_THAT( 293.6, WithinRel( chunkClipped.temperature() ) );
    std::vector<unsigned int> expected_groups(30);
    std::iota(expected_groups.begin(), expected_groups.end(), 1);
    for (size_t i = 0; i < chunkClipped.NGN(); ++i) {
        CHECK(expected_groups[i] == chunkClipped.groups()[i]);
    }
    std::vector < std::vector< std::vector< double> > > flux = {{{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
         0.0, 0.0, 2.235493e5, 4.396216e4, 2.311833e4, 1.410474e4, 1.905167e4,
         7.393531e4, 3.724272e3
        }}};
    for (size_t i = 0; i < chunkClipped.NGN(); ++i) {
        CHECK_THAT(flux[0][0][i], WithinRel(chunkClipped.flux(0, 0)[i]));
    }
    std::vector < std::vector< std::vector< double> > > sigma = {{{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
         0.0, 0.0, 1.047471e-2, 3.690336e-1, 6.475546e-1, 8.511604e-1, 7.647669e-1,
         5.483544e-1, 3.717841e-1
        }}};
    for (size_t i = 0; i < chunkClipped.NGN(); ++i) {
        CHECK_THAT(flux[0][0][i], WithinRel(chunkClipped.flux(0, 0)[i]));
    }
}