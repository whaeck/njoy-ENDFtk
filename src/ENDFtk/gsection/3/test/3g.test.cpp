// includes for Catch2
#include <catch2/catch_test_macros.hpp>
#include <catch2/matchers/catch_matchers_floating_point.hpp>
using Catch::Matchers::WithinRel;

// what we are testing
#include "ENDFtk/gsection/3g.hpp"

// other includes
#include "ENDFtk/tree/Section.hpp"
#include <numeric>
// Remove this
#include <iostream>

using namespace njoy::ENDFtk;

std::string chunk();
std::string validSEND();
std::string validMEND();
std::string validTEND();

void verifyChunk(const section::GType<3>& );

SCENARIO("section::GType<3>") {
    
    GIVEN("valid data for a section::GType<3>"){
        std::string sectionString = chunk() + validSEND();

        WHEN("the data is given as a string") {

        std::string line = chunk() + validSEND();
        auto begin = line.begin();
        auto end = line.end();
        long lineNumber = 0;
        auto head = StructureDivision(begin, end, lineNumber);

        section::GType<3> chunk(asHead(head), begin, end, lineNumber);

            THEN("a section GType<3> can be constructed and members can be tested") {
                verifyChunk(chunk);
            } // THEN

            THEN("it can be printed") {
                std::string buffer;
                auto output = std::back_inserter(buffer);
                chunk.print(output, 9228, 3, 1);

                CHECK(buffer == sectionString);
            }
        } // WHEN
    } // GIVEN
} // SCENARIO

std::string chunk() {
    return 
    " 9.223500+4 0.000000+0          2          3          0         309228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          19228 3  1     \n"
    " 1.270791+7 1.270790+7 1.197023+7 1.128546+7 2.016090+6 3.552522+59228 3  1     \n"
    " 6.266544+2 6.266548+2 6.162562+2 6.067706+2 5.303243+2 4.675096+29228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          29228 3  1     \n"
    " 1.149905+6 1.149905+6 1.124479+6 1.099624+6 3.559089+5 1.113871+59228 3  1     \n"
    " 2.261991+2 2.261991+2 2.261133+2 2.260272+2 2.230897+2 2.195244+29228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          39228 3  1     \n"
    " 1.158584+6 1.158584+6 1.147463+6 1.136454+6 5.945259+5 3.080750+59228 3  1     \n"
    " 9.695867+1 9.695867+1 9.691458+1 9.687056+1 9.487519+1 9.298089+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          49228 3  1     \n"
    " 1.148732+6 1.148732+6 1.143887+6 1.139071+6 8.277563+5 6.075435+59228 3  1     \n"
    " 4.242725+1 4.242725+1 4.235340+1 4.228004+1 3.877662+1 3.624642+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          59228 3  1     \n"
    " 1.155337+6 1.155337+6 1.149144+6 1.143039+6 8.242293+5 6.180888+59228 3  1     \n"
    " 5.437948+1 5.437948+1 5.388817+1 5.341036+1 4.017175+1 3.335129+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          69228 3  1     \n"
    " 1.154847+6 1.154847+6 1.141705+6 1.129072+6 6.987721+5 4.707030+59228 3  1     \n"
    " 1.185407+2 1.185407+2 1.151101+2 1.118811+2 6.526800+1 4.845287+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          79228 3  1     \n"
    " 1.153966+6 1.153966+6 1.144432+6 1.135065+6 7.170965+5 4.826207+59228 3  1     \n"
    " 8.411095+1 8.411095+1 8.330874+1 8.252645+1 6.092206+1 4.858386+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          89228 3  1     \n"
    " 1.154819+6 1.154819+6 1.149445+6 1.144111+6 8.250987+5 6.107359+59228 3  1     \n"
    " 4.690043+1 4.690043+1 4.675655+1 4.661387+1 3.996131+1 3.509910+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12          99228 3  1     \n"
    " 1.153684+6 1.153684+6 1.149437+6 1.145215+6 8.671104+5 6.661531+59228 3  1     \n"
    " 3.702289+1 3.702289+1 3.694638+1 3.687041+1 3.304928+1 3.016684+19228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         109228 3  1     \n" 
    " 1.154784+6 1.154784+6 1.151641+6 1.148509+6 9.151104+5 7.306688+59228 3  1     \n" 
    " 2.730364+1 2.730364+1 2.728690+1 2.727020+1 2.619063+1 2.524285+19228 3  1     \n" 
    " 2.936000+2 0.000000+0          2          1         12         119228 3  1     \n" 
    " 1.152800+6 1.152800+6 1.150432+6 1.148069+6 9.572601+5 7.958322+59228 3  1     \n" 
    " 2.058304+1 2.058304+1 2.058112+1 2.057925+1 2.042701+1 2.028417+19228 3  1     \n" 
    " 2.936000+2 0.000000+0          2          1         12         129228 3  1     \n" 
    " 1.156920+6 1.156920+6 1.154913+6 1.152910+6 9.854300+5 8.391668+59228 3  1     \n" 
    " 1.737549+1 1.737549+1 1.737619+1 1.737692+1 1.740253+1 1.742958+19228 3  1     \n" 
    " 2.936000+2 0.000000+0          2          1         12         139228 3  1     \n" 
    " 1.154341+6 1.154341+6 1.152599+6 1.150859+6 1.002600+6 8.706505+59228 3  1     \n" 
    " 1.511328+1 1.511328+1 1.511373+1 1.511419+1 1.513475+1 1.515522+19228 3  1     \n" 
    " 2.936000+2 0.000000+0          2          1         12         149228 3  1     \n" 
    " 1.157786+6 1.157786+6 1.156223+6 1.154663+6 1.019964+6 8.985596+59228 3  1     \n" 
    " 1.351391+1 1.351391+1 1.351390+1 1.351388+1 1.351245+1 1.351098+19228 3  1     \n" 
    " 2.936000+2 0.000000+0          2          1         12         159228 3  1     \n" 
    " 1.156371+6 1.156371+6 1.154994+6 1.153620+6 1.033272+6 9.232978+59228 3  1     \n" 
    " 1.191600+1 1.191600+1 1.191598+1 1.191594+1 1.191350+1 1.191100+19228 3  1     \n" 
    " 2.936000+2 0.000000+0          2          1         12         169228 3  1     \n" 
    " 5.809202+5 5.809202+5 5.803194+5 5.797192+5 5.264252+5 4.770473+59228 3  1     \n" 
    " 1.035308+1 1.035308+1 1.035307+1 1.035305+1 1.035190+1 1.035072+19228 3  1     \n" 
    " 2.936000+2 0.000000+0          2          1         12         179228 3  1     \n" 
    " 7.341455+5 7.341455+5 7.334852+5 7.328254+5 6.735186+5 6.179062+59228 3  1     \n" 
    " 9.002912+0 9.002912+0 9.002896+0 9.002881+0 9.001521+0 9.000132+09228 3  1     \n" 
    " 2.936000+2 0.000000+0          2          1         12         189228 3  1     \n" 
    " 1.030736+6 1.030736+6 1.029938+6 1.029141+6 9.566351+5 8.878708+59228 3  1     \n" 
    " 7.747087+0 7.747087+0 7.747076+0 7.747061+0 7.745969+0 7.744850+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         199228 3  1     \n"
    " 1.175655+6 1.175655+6 1.174846+6 1.174038+6 1.099930+6 1.029084+69228 3  1     \n"
    " 6.884748+0 6.884748+0 6.884747+0 6.884743+0 6.884560+0 6.884374+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         209228 3  1     \n"
    " 5.407961+5 5.407961+5 5.404268+5 5.400578+5 5.062082+5 4.738327+59228 3  1     \n"
    " 6.832784+0 6.832784+0 6.832784+0 6.832783+0 6.832738+0 6.832691+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         219228 3  1     \n"
    " 4.481701+5 4.481701+5 4.478473+5 4.475246+5 4.180345+5 3.899259+59228 3  1     \n"
    " 7.209057+0 7.209057+0 7.209055+0 7.209054+0 7.208877+0 7.208697+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         229228 3  1     \n"
    " 3.429532+5 3.429532+5 3.426903+5 3.424276+5 3.185175+5 2.958232+59228 3  1     \n"
    " 7.671847+0 7.671847+0 7.671845+0 7.671843+0 7.671702+0 7.671560+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         239228 3  1     \n"
    " 2.344895+5 2.344895+5 2.343027+5 2.341160+5 2.171752+5 2.011394+59228 3  1     \n"
    " 7.972503+0 7.972503+0 7.972503+0 7.972504+0 7.972488+0 7.972473+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         249228 3  1     \n"
    " 2.235493+5 2.235493+5 2.233755+5 2.232019+5 2.074169+5 1.924498+59228 3  1     \n"
    " 7.778415+0 7.778415+0 7.778410+0 7.778402+0 7.777768+0 7.777122+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         259228 3  1     \n"
    " 4.396216+4 4.396216+4 4.393264+4 4.390314+4 4.119423+4 3.860075+49228 3  1     \n"
    " 6.719709+0 6.719709+0 6.719703+0 6.719698+0 6.719217+0 6.718726+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         269228 3  1     \n"
    " 2.311833+4 2.311833+4 2.310431+4 2.309029+4 2.179531+4 2.054803+49228 3  1     \n"
    " 6.070456+0 6.070456+0 6.070453+0 6.070451+0 6.070241+0 6.070030+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         279228 3  1     \n"
    " 1.410474+4 1.410474+4 1.409665+4 1.408855+4 1.333844+4 1.261378+49228 3  1     \n"
    " 5.745072+0 5.745072+0 5.745068+0 5.745070+0 5.745052+0 5.745030+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         289228 3  1     \n"
    " 1.905167+4 1.905167+4 1.904072+4 1.902977+4 1.801546+4 1.703561+49228 3  1     \n"
    " 5.751786+0 5.751786+0 5.751786+0 5.751787+0 5.751784+0 5.751781+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         299228 3  1     \n"
    " 7.393531+4 7.393531+4 7.389235+4 7.384941+4 6.987280+4 6.603351+49228 3  1     \n"
    " 5.814161+0 5.814161+0 5.814160+0 5.814161+0 5.814157+0 5.814154+09228 3  1     \n"
    " 2.936000+2 0.000000+0          2          1         12         309228 3  1     \n"
    " 3.724272+3 3.724272+3 3.722040+3 3.719810+3 3.513643+3 3.314928+39228 3  1     \n"
    " 5.994611+0 5.994611+0 5.994612+0 5.994612+0 5.994582+0 5.994551+09228 3  1     \n";
}

std::string validSEND() {
    return
    "                                                                  9228 3  0     \n";
}

void verifyChunk(const section::GType<3>& chunk) {
    CHECK(92235 == chunk.ZA());
    CHECK(2 == chunk.NL());
    CHECK(2 == chunk.numberMoments());
    CHECK(30 == chunk.NGN());
    CHECK(30 == chunk.numberNeutronGroups());
    CHECK(3 == chunk.NZ());
    CHECK(3 == chunk.numberDilutions());
    CHECK(0 == chunk.LRFLAG());
    CHECK(0 == chunk.breakUpID());
    CHECK_THAT( 293.6, WithinRel( chunk.temperature() ) );
    std::vector<int> expected_groups(30);
    std::iota(expected_groups.begin(), expected_groups.end(), 1);
    for (size_t i = 0; i < chunk.NGN(); i++) {
        CHECK(expected_groups[i] == chunk.groups()[i]);
    }
    // flux_nl_nz
    std::vector<double> flux_0_0 = {1.270791e7, 1.149905e6, 1.158584e6, 1.148732e6, 1.155337e6, 1.154847e6, 1.153966e6,
       1.154819e6, 1.153684e6, 1.154784e6, 1.152800e6, 1.156920e6, 1.154341e6, 1.157786e6, 1.156371e6, 5.809202e5,
       7.341455e5, 1.030736e6, 1.175655e6, 5.407961e5, 4.481701e5, 3.429532e5, 2.344895e5, 2.235493e5, 4.396216e4,
       2.311833e4, 1.410474e4, 1.905167e4, 7.393531e4, 3.724272e3};
    for (size_t i = 0; i < chunk.NGN(); i++) {
        CHECK_THAT(flux_0_0[i], WithinRel(chunk.flux(0, 0)[i]));
    }
    std::vector<double> flux_1_2 = {3.552522e5, 1.113871e5, 3.080750e5, 6.075435e5, 6.180888e5, 4.707030e5, 4.826207e5,
        6.107359e5, 6.661531e5, 7.306688e5, 7.958322e5, 8.391668e5, 8.706505e5, 8.985596e5, 9.232978e5, 4.770473e5,
        6.179062e5, 8.878708e5, 1.029084e6, 4.738327e5, 3.899259e5, 2.958232e5, 2.011394e5, 1.924498e5, 3.860075e4,
        2.054803e4, 1.261378e4, 1.703561e4, 6.603351e4, 3.314928e3};
    for (size_t i = 0; i< chunk.NGN(); i++) {
        CHECK_THAT(flux_1_2[i], WithinRel(chunk.flux(1, 2)[i]));
    }
    std::vector<double> sigma_0_0 = {6.266544e2, 2.261991e2, 9.695867e1, 4.242725e1, 5.437948e1, 1.185407e2, 8.411095e1,
        4.690043e1, 3.702289e1, 2.730364e1, 2.058304e1, 1.737549e1, 1.511328e1, 1.351391e1, 1.191600e1, 1.035308e1,
        9.002912, 7.747087, 6.884748, 6.832784, 7.209057, 7.671847, 7.972503, 7.778415, 6.719709,
        6.070456, 5.745072, 5.751786, 5.814161, 5.994611};
    for (size_t i = 0; i < chunk.NGN(); i++) {
        CHECK_THAT(sigma_0_0[i], WithinRel(chunk.crossSection(0,0)[i]));
    }
    std::vector<double> sigma_0_2 = {5.303243e2, 2.230897e2, 9.487519e1, 3.877662e1, 4.017175e1, 6.526800e1, 6.092206e1,
        3.996131e1, 3.304928e1, 2.619063e1, 2.042701e1, 1.740253e1, 1.513475e1, 1.351245e1, 1.191350e1, 1.035190e1, 
        9.001521, 7.745969, 6.884560, 6.832738, 7.208877, 7.671702, 7.972488, 7.777768, 6.719217, 6.070241, 
        5.745052, 5.751784, 5.814157, 5.994582};
    for (size_t i = 0; i < chunk.NGN(); i++) {
        CHECK_THAT(sigma_0_2[i], WithinRel(chunk.crossSection(0,2)[i]));
    }
}